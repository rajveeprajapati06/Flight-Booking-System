<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment Successful | Skywings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF UMD (delivered from CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-100 to-green-300 flex items-center justify-center min-h-screen">

  <div class="bg-white rounded-3xl shadow-2xl p-8 w-[95%] max-w-2xl text-center">
    <h1 class="text-3xl font-bold text-green-700 mb-2">Payment Successful ✅</h1>
    <p class="text-gray-700 mb-6">Thank you for booking with <strong>Skywings</strong> — your e-ticket is ready.</p>

    <div id="summary" class="text-left text-gray-700 mb-6"></div>

    <div class="flex gap-4 justify-center">
      <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">Download Ticket</button>
      <a href="index.html" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold">Home</a>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    // Read booking info from localStorage
    const bookingInfo = JSON.parse(localStorage.getItem("bookingInfo")) || null;

    // Helper: generate random alphanum PNR (6 chars)
    function genPNR() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let pnr = "";
      for (let i = 0; i < 6; i++) pnr += chars.charAt(Math.floor(Math.random() * chars.length));
      return pnr;
    }

    // Helper: random seat like 12A
    function genSeat() {
      const row = Math.floor(Math.random() * 30) + 1; // 1-30
      const letters = ["A","B","C","D","E","F"];
      return row + letters[Math.floor(Math.random() * letters.length)];
    }

    // If no booking info, show message
    const summaryDiv = document.getElementById("summary");
    if (!bookingInfo) {
      summaryDiv.innerHTML = "<p class='text-red-600 text-center'>No booking found. Please make a booking first.</p>";
      document.getElementById("downloadBtn").disabled = true;
    } else {
      // enrich bookingInfo with ticket fields if not present
      if (!bookingInfo.pnr) bookingInfo.pnr = genPNR();
      if (!bookingInfo.seat) bookingInfo.seat = genSeat();
      if (!bookingInfo.gate) bookingInfo.gate = "G" + (Math.floor(Math.random() * 10) + 1); // G1-G10
      if (!bookingInfo.class) bookingInfo.class = "Economy";

      // display a small summary on the page
      summaryDiv.innerHTML = `
        <p><strong>Name:</strong> ${bookingInfo.name}</p>
        <p><strong>Destination:</strong> ${bookingInfo.destination}</p>
        <p><strong>Date:</strong> ${bookingInfo.date}</p>
        <p><strong>Airline:</strong> ${bookingInfo.flight.airline} — <strong>Flight</strong> ${bookingInfo.flight.flightNo}</p>
        <p><strong>PNR:</strong> ${bookingInfo.pnr} &nbsp; <strong>Seat:</strong> ${bookingInfo.seat} &nbsp; <strong>Gate:</strong> ${bookingInfo.gate}</p>
      `;

      // store updated bookingInfo back so subsequent pages see same PNR/seat
      localStorage.setItem("bookingInfo", JSON.stringify(bookingInfo));
    }

    // Ticket drawing function using jsPDF
    function generateTicketPDF(info) {
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const left = 40;
      const right = 555;
      const width = 515; // printable width for card
      const startY = 60;

      // Background card
      doc.setFillColor(245, 248, 255); // soft light blue
      doc.roundedRect(left - 10, startY - 20, width + 20, 300, 12, 12, "F");

      // Header bar
      doc.setFillColor(41, 121, 255); // blue
      doc.rect(left - 10, startY - 20, width + 20, 60, "F");

      // Logo (optional). Place file logo.png in same folder to include it.
      // We try to load the logo by creating an Image and converting to dataURL via canvas.
      // If logo not available, this step is skipped (handled by onload/onerror).
      function drawMainContent(imgDataURL) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(255,255,255);
        doc.text("Skywings", left + 10, startY + 18);

        // Draw logo image if provided (top-right of header)
        if (imgDataURL) {
          try {
            doc.addImage(imgDataURL, "PNG", right - 140, startY - 10, 120, 40);
          } catch (err) { /* ignore if image fails */ }
        }

        // Ticket main fields
        doc.setFontSize(12);
        doc.setTextColor(30,30,30);

        const col1X = left + 10;
        const col2X = left + 260;

        // Left column labels & values
        let y = startY + 60;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text("PASSENGER", col1X, y);
        doc.setFont("helvetica", "normal");
        doc.text(info.name, col1X, y + 18);

        doc.setFont("helvetica", "bold");
        doc.text("FLIGHT", col1X, y + 50);
        doc.setFont("helvetica", "normal");
        doc.text(`${info.flight.airline} • ${info.flight.flightNo}`, col1X, y + 68);

        doc.setFont("helvetica", "bold");
        doc.text("FROM", col1X, y + 96);
        doc.setFont("helvetica", "normal");
        doc.text("Current City", col1X, y + 114); // you may replace with origin if you track it

        doc.setFont("helvetica", "bold");
        doc.text("TO", col1X, y + 142);
        doc.setFont("helvetica", "normal");
        doc.text(info.destination, col1X, y + 160);

        // Right column fields
        doc.setFont("helvetica", "bold");
        doc.text("DATE", col2X, y);
        doc.setFont("helvetica", "normal");
        doc.text(info.date, col2X, y + 18);

        doc.setFont("helvetica", "bold");
        doc.text("DEPART", col2X, y + 50);
        doc.setFont("helvetica", "normal");
        doc.text(info.flight.departure, col2X, y + 68);

        doc.setFont("helvetica", "bold");
        doc.text("ARRIVE", col2X, y + 96);
        doc.setFont("helvetica", "normal");
        doc.text(info.flight.arrival, col2X, y + 114);

        doc.setFont("helvetica", "bold");
        doc.text("CLASS", col2X, y + 142);
        doc.setFont("helvetica", "normal");
        doc.text(info.class, col2X, y + 160);

        // bottom strip with PNR / seat / price
        const stripY = startY + 240;
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(left - 10, stripY, width + 20, 60, 8,8, "F");

        doc.setFont("helvetica", "bold");
        doc.setFontSize(13);
        doc.text(`PNR: ${info.pnr}`, left + 20, stripY + 36);
        doc.text(`Seat: ${info.seat}`, left + 160, stripY + 36);
        doc.text(`Gate: ${info.gate}`, left + 260, stripY + 36);

        doc.setFont("helvetica", "bold");
        doc.text(`${info.flight.price}`, right - 160, stripY + 36);

        // Draw barcode-like pattern on the right side of the card
        const barcodeX = right - 80;
        const barcodeY = startY + 40;
        const barcodeW = 60;
        const barcodeH = 190;
        // white background for barcode area
        doc.setFillColor(255,255,255);
        doc.rect(barcodeX - 6, barcodeY - 6, barcodeW + 12, barcodeH + 12, "F");
        // draw bars
        let barTop = barcodeY;
        for (let i = 0; i < 25; i++) {
          const barW = (Math.random() > 0.5) ? 6 : 3;
          const x = barcodeX + (i * 2.4);
          doc.setFillColor(40, 40, 40);
          doc.rect(x, barTop, barW, barcodeH, "F");
        }

        // Small footer text
        doc.setFontSize(9);
        doc.setTextColor(120,120,120);
        doc.text("Present this e-ticket at airport check-in. Terms & conditions apply.", left + 10, stripY + 80);
      }

      // Try to load logo.png from same folder and convert to dataURL, else draw without logo
      function loadLogoThenDraw(cb) {
        const logo = new Image();
        logo.crossOrigin = "Anonymous";
        logo.onload = function() {
          // draw onto canvas to get dataURL
          const canvas = document.createElement("canvas");
          canvas.width = logo.width;
          canvas.height = logo.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(logo, 0, 0);
          try {
            const dataURL = canvas.toDataURL("image/png");
            cb(dataURL);
          } catch (e) {
            cb(null);
          }
        };
        logo.onerror = function() { cb(null); };
        // try to load logo.png in same folder
        logo.src = "logo.png";
      }

      // wrapper to handle logo loading
      return new Promise(resolve => {
        loadLogoThenDraw(function (imgData) {
          drawMainContent(imgData);
          resolve(doc);
        });
      });
    }

    // Click handler for download button
    document.getElementById("downloadBtn").addEventListener("click", async function() {
      if (!bookingInfo) {
        alert("No booking found!");
        return;
      }

      // regenerate in case we want up-to-date info
      const pdfDoc = await generateTicketPDF(bookingInfo);
      // save by PNR
      const filename = `Skywings-Ticket-${bookingInfo.pnr}.pdf`;
      pdfDoc.save(filename);
    });

  </script>
</body>
</html>
